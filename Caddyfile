{
	email {$ACME_EMAIL}
}

# Portal — vigooth.com
{$DOMAIN} {
	root * /srv/portal
	file_server

	# SPA fallback
	try_files {path} /index.html

	# Cache Vite hashed assets immutably
	@assets path /assets/*
	header @assets Cache-Control "public, max-age=31536000, immutable"

	# Security headers
	header {
		X-Content-Type-Options nosniff
		X-Frame-Options DENY
		Referrer-Policy strict-origin-when-cross-origin
		-Server
	}
}

# Crypt-Lock — app-cryptlock.vigooth.com
app-cryptlock.{$DOMAIN} {
	root * /srv/cryptlock
	file_server

	# SPA fallback
	try_files {path} /index.html

	# Cache Vite hashed assets immutably
	@assets path /assets/*
	header @assets Cache-Control "public, max-age=31536000, immutable"

	# Strict security headers for password manager
	header {
		X-Content-Type-Options nosniff
		X-Frame-Options DENY
		Referrer-Policy strict-origin-when-cross-origin
		Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
		Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' https://api.{$DOMAIN}; font-src 'self'; object-src 'none'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'"
		Permissions-Policy "camera=(), microphone=(), geolocation=()"
		-Server
	}
}

# API — api.vigooth.com
api.{$DOMAIN} {
	# CORS — restricted to crypt-lock frontend
	@cors_preflight method OPTIONS
	handle @cors_preflight {
		header Access-Control-Allow-Origin "https://app-cryptlock.{$DOMAIN}"
		header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
		header Access-Control-Allow-Headers "Content-Type, Authorization"
		header Access-Control-Max-Age "86400"
		respond 204
	}

	reverse_proxy api:8090

	header {
		Access-Control-Allow-Origin "https://app-cryptlock.{$DOMAIN}"
		Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
		Access-Control-Allow-Headers "Content-Type, Authorization"
		X-Content-Type-Options nosniff
		-Server
	}
}
